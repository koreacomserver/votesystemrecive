<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•™êµ ì„ ê±° ê°œí‘œ ë°©ì†¡</title>
  <style>
    * { box-sizing: border-box; font-family: 'Pretendard', 'Segoe UI', sans-serif; }
    body { margin: 0; background: #0d1021; color: #fff; overflow: hidden; }

    header {
      background: linear-gradient(90deg, #2a2f66, #1c1f3a);
      padding: 10px 20px;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 1.2rem; font-weight: bold;
      border-bottom: 3px solid #3a52f8;
    }

    main {
      display: grid;
      grid-template-columns: 200px 1fr;
      height: calc(100vh - 60px);
    }

    .sidebar {
      background: #151832;
      padding: 1rem;
      display: flex; flex-direction: column; justify-content: space-around;
    }

    .sidebar div {
      background: #202456; padding: 1rem; border-radius: 10px;
      text-align: center; font-weight: bold; font-size: 1.1rem;
      border: 2px solid #4455cc; position: relative;
    }

    .sidebar .turnout {
      font-size: 0.9rem; color: #b0b8ff; margin-top: 8px;
    }

    .video-area {
      position: relative;
      background: black;
      display: flex; align-items: center; justify-content: center;
    }

    video { width: 100%; height: 100%; object-fit: cover; }

    .overlay {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(20, 24, 60, 0.9);
      display: grid; grid-template-columns: repeat(3, 1fr);
      padding: 15px 20px;
      gap: 10px;
    }

    .card {
      background: #161a3a;
      border-radius: 10px;
      padding: 10px 15px;
      display: flex; flex-direction: column;
      border: 2px solid #3a52f8;
      position: relative;
    }

    .card-header { font-size: 1.1rem; margin-bottom: 8px; font-weight: bold; color: #89a9ff; }

    .candidate { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
    .bar-bg { background: #202856; height: 10px; border-radius: 5px; overflow: hidden; width: 60%; }
    .bar-fill { background: #4a6eff; height: 10px; transition: width 0.5s; }
    .percent { font-weight: bold; width: 40px; text-align: right; }

    .badge {
      position: absolute;
      top: 8px;
      right: 10px;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: bold;
      color: #000;
    }

    .likely {
      background: linear-gradient(90deg, #ffd84d, #ffed8a);
    }

    .confirmed {
      background: linear-gradient(90deg, #ffcc33, #fff2a8, #ffe680);
      color: #3b2f00;
    }
  </style>
</head>
<body>
  <header>
    <div>2026 ê²½ì‹ ì¤‘í•™êµ ì „êµ ì„ ê±°ë°©ì†¡</div>
    <div id="clock"></div>
  </header>

  <main>
    <div class="sidebar" id="sidebar">
      <div id="side-president">íšŒì¥<div class="turnout" id="turnout-president">íˆ¬í‘œìœ¨: 0%</div></div>
      <div id="side-vp_3rd">3í•™ë…„ ë¶€íšŒì¥<div class="turnout" id="turnout-vp_3rd">íˆ¬í‘œìœ¨: 0%</div></div>
      <div id="side-vp_2nd">2í•™ë…„ ë¶€íšŒì¥<div class="turnout" id="turnout-vp_2nd">íˆ¬í‘œìœ¨: 0%</div></div>
    </div>

    <div class="video-area">
      <video id="broadcastVideo" controls loop></video>
      <input type="file" id="videoUpload" accept="video/*" style="position:absolute;top:10px;right:10px;z-index:2;" />
      <div class="overlay" id="results"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCLge3LmR3bCTb7gKnVMVh2s_xt7zpdQYg",
      authDomain: "votesystemserver.firebaseapp.com",
      projectId: "votesystemserver",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const positions = [
      { key: 'president', label: 'íšŒì¥' },
      { key: 'vp_3rd', label: '3í•™ë…„ ë¶€íšŒì¥' },
      { key: 'vp_2nd', label: '2í•™ë…„ ë¶€íšŒì¥' }
    ];

    // ì§ì±…ë³„ ìœ ê¶Œì ìˆ˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì €ì¥í•  ë§µ (Manager ì•±ê³¼ ë™ê¸°í™”)
    const voterCounts = {};

    async function renderAll() {
      const container = document.getElementById('results');
      container.innerHTML = '';

      for (const pos of positions) {
        // 1. ì¹´ë“œ êµ¬ì¡° ìƒì„±
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `card-${pos.key}`;
        container.appendChild(card);

        // 2. ìœ ê¶Œì ìˆ˜ (meta ë¬¸ì„œ) ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const metaDocRef = doc(db, `elections/2025/${pos.key}/meta`);
        onSnapshot(metaDocRef, (metaSnap) => {
            if (metaSnap.exists()) {
                // ìœ ê¶Œì ìˆ˜ ì—…ë°ì´íŠ¸
                voterCounts[pos.key] = Number(metaSnap.data().totalVoters) || 0;
            } else {
                voterCounts[pos.key] = 0;
            }
        });

        // 3. í›„ë³´ì ë“í‘œìˆ˜ (ì»¬ë ‰ì…˜) ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const col = collection(db, `elections/2025/${pos.key}`);
        onSnapshot(col, snap => {
          const data = [];
          snap.forEach(doc => {
            // ğŸ”¥ ìˆ˜ì •ëœ ë¶€ë¶„: ë¬¸ì„œ IDê°€ 'meta'ì¸ ê²½ìš° í›„ë³´ì ëª©ë¡ì—ì„œ ì œì™¸
            if (doc.id === 'meta') { 
              return; 
            }
            data.push({ id: doc.id, ...doc.data() });
          });
          
          data.sort((a, b) => b.votes - a.votes);
          const top3 = data.slice(0, 3);
          const totalVotesCast = data.reduce((sum, c) => sum + Number(c.votes || 0), 0);
          
          const totalVoters = voterCounts[pos.key] || 0;

          // íˆ¬í‘œìœ¨ ê³„ì‚° (Total Votes Cast / Total Registered Voters)
          const turnoutPercent = totalVoters > 0 ? ((totalVotesCast / totalVoters) * 100).toFixed(1) : '0.0';

          // ì‚¬ì´ë“œë°” íˆ¬í‘œìœ¨ ì—…ë°ì´íŠ¸
          const turnoutEl = document.getElementById(`turnout-${pos.key}`);
          if (turnoutEl) turnoutEl.textContent = `íˆ¬í‘œìœ¨: ${turnoutPercent}%`;


          const cardEl = document.getElementById(`card-${pos.key}`);
          // ì¹´ë“œ ë‚´ìš© ì—…ë°ì´íŠ¸ (í›„ë³´ì ë“í‘œìœ¨)
          cardEl.innerHTML = `
            <div class='card-header'>${pos.label}</div>
            ${top3.map(c => {
              // í›„ë³´ì ë“í‘œìœ¨ ê³„ì‚°ì€ ì´ íˆ¬í‘œìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.
              const candidatePercent = totalVotesCast ? ((c.votes/totalVotesCast*100).toFixed(1)) : '0.0';
              return `
                <div class='candidate'>
                  <span>${c.name}</span>
                  <div class='bar-bg'><div class='bar-fill' style='width:${candidatePercent}%'></div></div>
                  <span class='percent'>${candidatePercent}%</span>
                </div>
              `;
            }).join('')}
          `;

          // ë°°ì§€ ì—…ë°ì´íŠ¸ (íˆ¬í‘œ ì™„ë£Œ ìƒíƒœ)
          const existingBadge = cardEl.querySelector('.badge');
          if (existingBadge) existingBadge.remove();

          const turnoutNum = parseFloat(turnoutPercent);

          if (turnoutNum >= 98) {
              const badge = document.createElement('div');
              badge.className = 'badge confirmed';
              badge.textContent = 'ë‹¹ì„  í™•ì •'; // íˆ¬í‘œ ì™„ë£Œê°€ 98% ì´ìƒì¼ ë•Œ ë‹¹ì„  í™•ì •ìœ¼ë¡œ ê°„ì£¼
              cardEl.appendChild(badge);
          } else if (turnoutNum >= 80) {
              const badge = document.createElement('div');
              badge.className = 'badge likely';
              badge.textContent = 'ê°œí‘œ ì™„ë£Œ ì„ë°•'; // íˆ¬í‘œ ì™„ë£Œê°€ 80% ì´ìƒì¼ ë•Œ
              cardEl.appendChild(badge);
          }
        }); // end onSnapshot(col, ...)
      } // end for loop
    } // end renderAll

    // ê¸°ì¡´ì˜ loadTurnout ë° setInterval ëŒ€ì‹  renderAll í˜¸ì¶œ
    renderAll(); 

    const videoInput = document.getElementById('videoUpload');
    const video = document.getElementById('broadcastVideo');
    videoInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        video.src = URL.createObjectURL(file);
        video.play();
      }
    });

    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('ko-KR');
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>
