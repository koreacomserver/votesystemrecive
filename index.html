<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•™êµ ì„ ê±° ê°œí‘œ ë°©ì†¡</title>
  <style>
    /* Pretendard í°íŠ¸ ì¶”ê°€ */
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
    * { box-sizing: border-box; font-family: 'Pretendard', 'Segoe UI', sans-serif; }
    body { margin: 0; background: #0d1021; color: #fff; overflow: hidden; }

    header {
      background: linear-gradient(90deg, #2a2f66, #1c1f3a);
      padding: 10px 20px;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 1.2rem; font-weight: bold;
      border-bottom: 3px solid #3a52f8;
    }

    main {
      display: grid;
      grid-template-columns: 200px 1fr;
      height: calc(100vh - 60px);
    }

    .sidebar {
      background: #151832;
      padding: 1rem;
      display: flex; flex-direction: column; justify-content: space-around;
    }

    .sidebar div {
      background: #202456; padding: 1rem; border-radius: 10px;
      text-align: center; font-weight: bold; font-size: 1.1rem;
      border: 2px solid #4455cc; position: relative;
    }

    .sidebar .turnout {
      font-size: 0.9rem; color: #b0b8ff; margin-top: 8px;
    }

    .video-area {
      position: relative;
      background: black;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
      border: 3px dashed transparent;
      transition: border-color 0.3s;
    }
    
    .video-area.drag-over {
        border-color: #4a6eff;
    }

    canvas { 
        width: 100%; height: 100%; 
        object-fit: cover; 
        display: block; 
        background: #000; 
        position: absolute; 
        top: 0; left: 0; 
        z-index: 1; 
    }
    
    #broadcastVideo {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: contain;
        z-index: 2; 
        display: none; 
    }

    /* ë¼ì´ë¸Œ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
    #liveTallyOverlay {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    .live-badge {
        background: #e74c3c; 
        padding: 5px 15px;
        border-radius: 5px;
        font-weight: 900;
        font-size: 1.5rem;
        animation: pulse 1.5s infinite;
        border: 2px solid white;
    }

    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
    }

    #tallyTicker {
        background: rgba(30, 40, 70, 0.8);
        padding: 8px 20px;
        border-radius: 5px;
        font-size: 1.1rem;
        font-weight: bold;
        border-left: 5px solid #3a6ff8;
        min-width: 300px;
    }
    
    /* í•˜ë‹¨ ì¹´ë“œ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
    .overlay {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(20, 24, 60, 0.9);
      display: grid; grid-template-columns: repeat(3, 1fr);
      padding: 15px 20px;
      gap: 10px;
      z-index: 10;
    }

    .card {
      background: #161a3a;
      border-radius: 10px;
      padding: 10px 15px;
      display: flex; flex-direction: column;
      border: 2px solid #3a52f8;
      position: relative;
    }

    .card-header { font-size: 1.1rem; margin-bottom: 8px; font-weight: bold; color: #89a9ff; }

    /* í›„ë³´ì í•­ëª© */
    .candidate { 
        display: flex; 
        flex-direction: column; /* ì´ë¦„ì„ í•œ ì¤„, ë°”/í¼ì„¼íŠ¸ë¥¼ ë‹¤ë¥¸ ì¤„ì— ë°°ì¹˜í•˜ê¸° ìœ„í•´ ì»¬ëŸ¼ìœ¼ë¡œ ë³€ê²½ */
        margin: 6px 0; 
    }
    
    .candidate-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px; /* ì´ë¦„ê³¼ ë°” ì‚¬ì´ ê°„ê²© */
    }
    
    .candidate-name-group {
        display: flex;
        align-items: center;
        font-weight: bold;
        color: white;
    }

    /* ğŸŒŸ í›„ë³´ì ì´ë¦„ ì˜†ì— ë¶™ëŠ” ìƒíƒœ ë°°ì§€ ìŠ¤íƒ€ì¼ */
    .candidate-status {
      margin-left: 8px;
      padding: 3px 6px;
      border-radius: 5px;
      font-size: 0.7rem;
      font-weight: 900;
      line-height: 1; /* ë†’ì´ ì¡°ì ˆ */
      text-transform: uppercase;
      transform: translateY(-1px);
    }

    /* ğŸŒŸ ë‹¹ì„  í™•ì • ìŠ¤íƒ€ì¼ */
    .confirmed {
      background: linear-gradient(90deg, #ffcc33, #fff2a8);
      color: #3b2f00;
    }

    /* ğŸŒŸ ë‹¹ì„  ì„ë°• ìŠ¤íƒ€ì¼ */
    .likely {
      background: linear-gradient(90deg, #ffd84d, #ffed8a);
      color: #3b2f00;
    }

    .candidate-bar-area {
        display: flex;
        align-items: center;
    }

    .bar-bg { background: #202856; height: 10px; border-radius: 5px; overflow: hidden; width: 60%; }
    .bar-fill { background: #4a6eff; height: 10px; transition: width 0.5s; }
    .percent { font-weight: bold; width: 40%; text-align: right; color: #89a9ff; }


    #dragDropText {
        position: absolute;
        color: rgba(255, 255, 255, 0.3);
        font-size: 2rem;
        font-weight: bold;
        pointer-events: none; 
        z-index: 10;
    }
  </style>
</head>
<body>
  <header>
    <div>2026 ê²½ì‹ ì¤‘í•™êµ ì „êµ ì„ ê±°ë°©ì†¡</div>
    <div id="clock"></div>
  </header>

  <main>
    <div class="sidebar" id="sidebar">
      <div id="side-president">íšŒì¥<div class="turnout" id="turnout-president">íˆ¬í‘œìœ¨: 0%</div></div>
      <div id="side-vp_3rd">3í•™ë…„ ë¶€íšŒì¥<div class="turnout" id="turnout-vp_3rd">íˆ¬í‘œìœ¨: 0%</div></div>
      <div id="side-vp_2nd">2í•™ë…„ ë¶€íšŒì¥<div class="turnout" id="turnout-vp_2nd">íˆ¬í‘œìœ¨: 0%</div></div>
    </div>

    <div class="video-area" id="videoArea">
      <div id="dragDropText">ì˜ìƒì„ ë“œë˜ê·¸í•˜ì—¬ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”</div>

      <video id="broadcastVideo" controls></video>
      
      <canvas id="broadcastCanvas"></canvas>
      
      <div id="liveTallyOverlay">
          <div class="live-badge">LIVE</div>
          <div id="tallyTicker">ê°œí‘œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      </div>
      
      <div class="overlay" id="results"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // --- Firebase ì„¤ì • ---
    const firebaseConfig = {
      apiKey: "AIzaSyCLge3LmR3bCTb7gKnVMVh2s_xt7zpdQYg",
      authDomain: "votesystemserver.firebaseapp.com",
      projectId: "votesystemserver",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const positions = [
      { key: 'president', label: 'íšŒì¥' },
      { key: 'vp_3rd', label: '3í•™ë…„ ë¶€íšŒì¥' },
      { key: 'vp_2nd', label: '2í•™ë…„ ë¶€íšŒì¥' }
    ];

    const voterCounts = {};
    const leadingCandidates = {}; 
    let currentTickerIndex = 0;

    // --- Canvas ë° ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ---
    const canvas = document.getElementById('broadcastCanvas');
    const ctx = canvas.getContext('2d');
    const videoElement = document.getElementById('broadcastVideo');
    const videoArea = document.getElementById('videoArea');
    const dragDropText = document.getElementById('dragDropText');

    let width, height;

    function resizeCanvas() {
        width = canvas.clientWidth;
        height = canvas.clientHeight;
        canvas.width = width;
        canvas.height = height;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    let broadcastState = 'LIVE';
    let currentPositionIndex = 0; 
    const rotationInterval = 3000; 

    const animatedCandidateData = {};

    // ìº”ë²„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ í—¬í¼ í•¨ìˆ˜
    function animateValue(obj, start, end, duration, propertyName) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj[propertyName] = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }
    
    function animatePercent(obj, start, end, duration, propertyName) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj[propertyName] = (progress * (end - start) + start); 
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    function drawBackgroundGrid() {
        ctx.fillStyle = '#0d1021';
        ctx.fillRect(0, 0, width, height);

        ctx.strokeStyle = 'rgba(58, 111, 248, 0.1)';
        ctx.lineWidth = 1;

        const gridSize = 50;
        for (let x = 0; x < width; x += gridSize) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
        }
        for (let y = 0; y < height; y += gridSize) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
        }
    }

    let flowParticles = [];
    const MAX_FLOW_PARTICLES = 30;

    class FlowParticle {
        constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.vx = (Math.random() - 0.5) * 1.5;
            this.vy = (Math.random() - 0.5) * 1.5;
            this.radius = Math.random() * 1.5 + 0.5;
            this.alpha = Math.random() * 0.8 + 0.2;
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.alpha -= 0.005;

            if (this.alpha <= 0 || this.x < 0 || this.x > width || this.y < 0 || this.y > height) {
                this.reset();
            }
        }

        reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.vx = (Math.random() - 0.5) * 1.5;
            this.vy = (Math.random() - 0.5) * 1.5;
            this.alpha = Math.random() * 0.8 + 0.2;
        }

        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(58, 111, 248, ${this.alpha})`;
            ctx.fill();
        }
    }

    function initFlowParticles() {
        for (let i = 0; i < MAX_FLOW_PARTICLES; i++) {
            flowParticles.push(new FlowParticle());
        }
    }
    initFlowParticles();

    // LIVE ìƒíƒœ (ì‹¤ì‹œê°„ ë§‰ëŒ€ ê·¸ë˜í”„)
    function drawLiveTally() {
        const mainPositionKey = positions[currentPositionIndex].key; 
        const mainData = animatedCandidateData[mainPositionKey];
        const positionLabel = positions[currentPositionIndex].label;

        if (!mainData || mainData.length === 0) {
            ctx.fillStyle = 'white';
            ctx.font = '24px Pretendard';
            ctx.textAlign = 'center';
            ctx.fillText(`${positionLabel} ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...`, width / 2, height / 2);
            return;
        }

        const graphAreaX = width * 0.1;
        const graphAreaY = height * 0.2;
        const graphAreaWidth = width * 0.8;
        const barHeight = 60;
        const barSpacing = 20;

        ctx.font = '36px Pretendard';
        ctx.fillStyle = '#89a9ff';
        ctx.textAlign = 'left';
        ctx.fillText(`[${positionLabel}] ë“í‘œ í˜„í™©`, graphAreaX, graphAreaY - 40);

        mainData.forEach((c, index) => {
            const y = graphAreaY + index * (barHeight + barSpacing);
            
            ctx.fillStyle = 'rgba(32, 40, 86, 0.6)';
            ctx.fillRect(graphAreaX, y, graphAreaWidth, barHeight);

            const currentBarWidth = graphAreaWidth * (c.currentPercent / 100);
            ctx.fillStyle = '#4a6eff'; 
            ctx.fillRect(graphAreaX, y, currentBarWidth, barHeight);

            ctx.fillStyle = 'white';
            ctx.font = 'bold 28px Pretendard';
            ctx.fillText(c.name, graphAreaX + 20, y + barHeight / 2 + 10);

            ctx.font = 'bold 32px Pretendard';
            ctx.textAlign = 'right';
            ctx.fillText(`${c.currentPercent.toFixed(1)}%`, graphAreaX + graphAreaWidth - 20, y + barHeight / 2 + 12);

            ctx.font = '22px Pretendard';
            ctx.fillStyle = '#ccc';
            ctx.fillText(`${c.currentVotes.toLocaleString()}í‘œ`, graphAreaX + graphAreaWidth - 20, y + barHeight / 2 + 40);

            ctx.textAlign = 'left'; 
        });
    }

    function animateCanvas() {
        if (broadcastState === 'LIVE') {
            document.getElementById('liveTallyOverlay').style.display = 'flex';
            document.getElementById('results').style.display = 'grid'; 
            dragDropText.style.display = 'block';

            drawBackgroundGrid();
            flowParticles.forEach(p => { p.update(); p.draw(); }); 
            drawLiveTally();
        } else if (broadcastState === 'VIDEO') {
            drawBackgroundGrid(); 
        }

        requestAnimationFrame(animateCanvas);
    }
    animateCanvas();

    // 3ì´ˆë§ˆë‹¤ ê·¸ë˜í”„ ìˆœí™˜ ì‹œì‘
    function startGraphRotation() {
        setInterval(() => {
            if (broadcastState === 'LIVE') {
                currentPositionIndex = (currentPositionIndex + 1) % positions.length;
            }
        }, rotationInterval);
    }
    startGraphRotation();


    // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë° ì˜ìƒ ì¬ìƒ ë¡œì§ ---

    function setBroadcastMode(mode) {
        broadcastState = mode;
        if (mode === 'LIVE') {
            videoElement.style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('results').style.display = 'grid'; 
            document.getElementById('liveTallyOverlay').style.display = 'flex';
            dragDropText.style.display = 'block';
            videoElement.pause();
            videoElement.src = '';
            URL.revokeObjectURL(videoElement.src);
        } else if (mode === 'VIDEO') {
            canvas.style.display = 'none';
            videoElement.style.display = 'block';
            document.getElementById('results').style.display = 'none'; 
            document.getElementById('liveTallyOverlay').style.display = 'none';
            dragDropText.style.display = 'none';
        }
    }

    videoArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        videoArea.classList.add('drag-over');
    });

    videoArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        videoArea.classList.remove('drag-over');
    });

    videoArea.addEventListener('drop', (e) => {
        e.preventDefault();
        videoArea.classList.remove('drag-over');

        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('video/')) {
            const videoURL = URL.createObjectURL(file);
            videoElement.src = videoURL;
            videoElement.play().catch(error => {
                console.error("Video playback failed:", error);
            });
            
            setBroadcastMode('VIDEO');
        }
    });

    videoElement.onended = () => {
        setBroadcastMode('LIVE'); 
    };


    // --- Firebase ë°ì´í„° ë¡œì§ ---

    async function renderAll() {
      const container = document.getElementById('results');
      container.innerHTML = '';

      for (const pos of positions) {
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `card-${pos.key}`;
        container.appendChild(card);

        const metaDocRef = doc(db, `elections/2025/${pos.key}/meta`);
        onSnapshot(metaDocRef, (metaSnap) => {
            if (metaSnap.exists()) {
                voterCounts[pos.key] = Number(metaSnap.data().totalVoters) || 0;
            } else {
                voterCounts[pos.key] = 0;
            }
        });

        const col = collection(db, `elections/2025/${pos.key}`);
        onSnapshot(col, snap => {
          const data = [];
          snap.forEach(doc => {
            if (doc.id === 'meta') { 
              return; 
            }
            data.push({ id: doc.id, ...doc.data() });
          });
          
          data.sort((a, b) => b.votes - a.votes);
          const top3 = data.slice(0, 3);
          const totalVotesCast = data.reduce((sum, c) => sum + Number(c.votes || 0), 0);
          
          const totalVoters = voterCounts[pos.key] || 0;

          const turnoutPercent = totalVoters > 0 ? ((totalVotesCast / totalVoters) * 100).toFixed(1) : '0.0';

          const turnoutEl = document.getElementById(`turnout-${pos.key}`);
          if (turnoutEl) turnoutEl.textContent = `íˆ¬í‘œìœ¨: ${turnoutPercent}%`;
          
          if (top3.length > 0) {
              const winnerData = top3[0];
              const percent = totalVotesCast ? ((winnerData.votes / totalVotesCast) * 100).toFixed(1) : '0.0';
              
              leadingCandidates[pos.key] = {
                  label: pos.label,
                  name: winnerData.name,
                  percent: percent,
                  votes: winnerData.votes
              };
          } else {
               leadingCandidates[pos.key] = null;
          }

          const cardEl = document.getElementById(`card-${pos.key}`);
          
          // ğŸŒŸ ë‹¹ì„  í™•ì • ë° ì„ë°• ìƒíƒœ ê²°ì •
          const turnoutNum = parseFloat(turnoutPercent);
          let candidateStatusBadge = '';
          let topCandidateId = top3.length > 0 ? top3[0].id : null;
          
          // ë“í‘œ 1ìœ„ í›„ë³´ìì—ê²Œë§Œ ìƒíƒœ ë°°ì§€ í‘œì‹œ
          if (turnoutNum >= 98 && topCandidateId) {
              candidateStatusBadge = '<span data-candidate-id="' + topCandidateId + '" class="candidate-status confirmed">ë‹¹ì„  í™•ì •</span>';
          } else if (turnoutNum >= 80 && topCandidateId) {
              candidateStatusBadge = '<span data-candidate-id="' + topCandidateId + '" class="candidate-status likely">ë‹¹ì„  ì„ë°•</span>';
          }


          // ğŸŒŸ ì¹´ë“œ ë‚´ìš© ì—…ë°ì´íŠ¸ (í›„ë³´ì ë“í‘œìœ¨)
          cardEl.innerHTML = `
            <div class='card-header'>${pos.label}</div>
            ${top3.map(c => {
              const candidatePercent = totalVotesCast ? ((c.votes/totalVotesCast*100).toFixed(1)) : '0.0';
              
              // 1ìœ„ í›„ë³´ìì—ê²Œë§Œ ë°°ì§€ HTMLì„ ë¶™ì—¬ì¤ë‹ˆë‹¤.
              const statusHtml = (c.id === topCandidateId) ? candidateStatusBadge : '';

              return `
                <div class='candidate'>
                    <div class='candidate-info'>
                        <div class='candidate-name-group'>
                            <span>${c.name}</span>
                            ${statusHtml} 
                        </div>
                    </div>
                    <div class='candidate-bar-area'>
                        <div class='bar-bg'><div class='bar-fill' style='width:${candidatePercent}%'></div></div>
                        <span class='percent'>${candidatePercent}%</span>
                    </div>
                </div>
              `;
            }).join('')}
          `;

          // ìº”ë²„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ìš© ë°ì´í„° ì—…ë°ì´íŠ¸
          const animationDuration = 800;
          const currentAnimatedData = animatedCandidateData[pos.key] || [];
          const newAnimatedData = [];
          
          data.forEach(c => {
              const existing = currentAnimatedData.find(ac => ac.id === c.id);
              const targetVotes = Number(c.votes || 0);
              const targetPercent = totalVotesCast ? ((targetVotes / totalVotesCast) * 100) : 0;

              if (existing) {
                  animateValue(existing, existing.currentVotes, targetVotes, animationDuration, 'currentVotes');
                  animatePercent(existing, existing.currentPercent, targetPercent, animationDuration, 'currentPercent');
                  newAnimatedData.push(existing);
              } else {
                  const newCand = { 
                      id: c.id, 
                      name: c.name, 
                      currentVotes: 0, 
                      targetVotes: targetVotes,
                      currentPercent: 0,
                      targetPercent: targetPercent
                  };
                  animateValue(newCand, 0, targetVotes, animationDuration, 'currentVotes');
                  animatePercent(newCand, 0, targetPercent, animationDuration, 'currentPercent');
                  newAnimatedData.push(newCand);
              }
          });
          animatedCandidateData[pos.key] = newAnimatedData;
          
        });
      }
    } 
    
    // ë¼ì´ë¸Œ í‹°ì»¤ë¥¼ ìˆœí™˜í•˜ë©° ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateLiveTallyTicker() {
        if (broadcastState === 'VIDEO') return;

        const keys = positions.map(p => p.key).filter(k => leadingCandidates[k]);
        
        const tickerEl = document.getElementById('tallyTicker');

        if (keys.length === 0) {
            tickerEl.textContent = "ğŸ“¢ ê°œí‘œ ì •ë³´ ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘... (ê´€ë¦¬ì ì•±ì—ì„œ í›„ë³´ìë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.)";
            return;
        }

        currentTickerIndex = (currentTickerIndex + 1) % keys.length;
        const currentKey = keys[currentTickerIndex];
        const leader = leadingCandidates[currentKey];

        tickerEl.textContent = `âš¡ï¸ ${leader.label} (ì„ ë‘: ${leader.name}) - ë“í‘œìœ¨ ${leader.percent}% / ${leader.votes}í‘œ`;
    }

    renderAll(); 

    // 3ì´ˆë§ˆë‹¤ ë¼ì´ë¸Œ í‹°ì»¤ ì—…ë°ì´íŠ¸ ì‹œì‘
    setInterval(updateLiveTallyTicker, 3000); 

    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('ko-KR');
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>
