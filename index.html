<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>학교 선거 개표 방송</title>
  <style>
    * { box-sizing: border-box; font-family: 'Pretendard', 'Segoe UI', sans-serif; }
    body { margin: 0; background: #0d1021; color: #fff; overflow: hidden; }

    header {
      background: linear-gradient(90deg, #2a2f66, #1c1f3a);
      padding: 10px 20px;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 1.2rem; font-weight: bold;
      border-bottom: 3px solid #3a52f8;
    }

    main {
      display: grid;
      grid-template-columns: 200px 1fr;
      height: calc(100vh - 60px);
    }

    .sidebar {
      background: #151832;
      padding: 1rem;
      display: flex; flex-direction: column; justify-content: space-around;
    }

    .sidebar div {
      background: #202456; padding: 1rem; border-radius: 10px;
      text-align: center; font-weight: bold; font-size: 1.1rem;
      border: 2px solid #4455cc; position: relative;
    }

    .sidebar .turnout {
      font-size: 0.9rem; color: #b0b8ff; margin-top: 8px;
    }

    .video-area {
      position: relative;
      background: black;
      display: flex; align-items: center; justify-content: center;
    }

    video { width: 100%; height: 100%; object-fit: cover; }

    .overlay {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(20, 24, 60, 0.9);
      display: grid; grid-template-columns: repeat(3, 1fr);
      padding: 15px 20px;
      gap: 10px;
    }

    .card {
      background: #161a3a;
      border-radius: 10px;
      padding: 10px 15px;
      display: flex; flex-direction: column;
      border: 2px solid #3a52f8;
      position: relative;
    }

    .card-header { font-size: 1.1rem; margin-bottom: 8px; font-weight: bold; color: #89a9ff; }

    .candidate { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
    .bar-bg { background: #202856; height: 10px; border-radius: 5px; overflow: hidden; width: 60%; }
    .bar-fill { background: #4a6eff; height: 10px; transition: width 0.5s; }
    .percent { font-weight: bold; width: 40px; text-align: right; }

    .badge {
      position: absolute;
      top: 8px;
      right: 10px;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: bold;
      color: #000;
    }

    .likely {
      background: linear-gradient(90deg, #ffd84d, #ffed8a);
    }

    .confirmed {
      background: linear-gradient(90deg, #ffcc33, #fff2a8, #ffe680);
      color: #3b2f00;
    }
  </style>
</head>
<body>
  <header>
    <div>2026 경신중학교 전교 선거방송</div>
    <div id="clock"></div>
  </header>

  <main>
    <div class="sidebar" id="sidebar">
      <div id="side-president">회장<div class="turnout" id="turnout-president">투표율: 0%</div></div>
      <div id="side-vp_3rd">3학년 부회장<div class="turnout" id="turnout-vp_3rd">투표율: 0%</div></div>
      <div id="side-vp_2nd">2학년 부회장<div class="turnout" id="turnout-vp_2nd">투표율: 0%</div></div>
    </div>

    <div class="video-area">
      <video id="broadcastVideo" controls loop></video>
      <input type="file" id="videoUpload" accept="video/*" style="position:absolute;top:10px;right:10px;z-index:2;" />
      <div class="overlay" id="results"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCLge3LmR3bCTb7gKnVMVh2s_xt7zpdQYg",
      authDomain: "votesystemserver.firebaseapp.com",
      projectId: "votesystemserver",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const positions = [
      { key: 'president', label: '회장' },
      { key: 'vp_3rd', label: '3학년 부회장' },
      { key: 'vp_2nd', label: '2학년 부회장' }
    ];

    async function renderAll() {
      const container = document.getElementById('results');
      container.innerHTML = '';

      for (const pos of positions) {
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `card-${pos.key}`;
        container.appendChild(card);

        const col = collection(db, `elections/2025/${pos.key}`);
        onSnapshot(col, snap => {
          const data = [];
          snap.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
          data.sort((a, b) => b.votes - a.votes);
          const top3 = data.slice(0, 3);
          const total = data.reduce((sum, c) => sum + Number(c.votes || 0), 0);

          const cardEl = document.getElementById(`card-${pos.key}`);
          cardEl.innerHTML = `
            <div class='card-header'>${pos.label}</div>
            ${top3.map(c => `
              <div class='candidate'>
                <span>${c.name}</span>
                <div class='bar-bg'><div class='bar-fill' style='width:${(c.votes/total*100).toFixed(1)}%'></div></div>
                <span class='percent'>${((c.votes/total)*100).toFixed(1)}%</span>
              </div>
            `).join('')}
          `;
        });
      }
    }

    async function loadTurnout() {
      const meta = await getDoc(doc(db, 'elections/2025/meta'));
      if (meta.exists()) {
        const { totalVoters, voted } = meta.data();
        const percent = totalVoters ? ((voted / totalVoters) * 100).toFixed(1) : 0;

        // 각 포지션별 투표율 표시
        positions.forEach(pos => {
          const turnoutEl = document.getElementById(`turnout-${pos.key}`);
          if (turnoutEl) turnoutEl.textContent = `투표율: ${percent}%`;
        });

        // 당선/유력 배지 처리
        positions.forEach(pos => {
          const cardEl = document.getElementById(`card-${pos.key}`);
          if (!cardEl) return;
          const existingBadge = cardEl.querySelector('.badge');
          if (existingBadge) existingBadge.remove();

          if (percent >= 98) {
            const badge = document.createElement('div');
            badge.className = 'badge confirmed';
            badge.textContent = '당선';
            cardEl.appendChild(badge);
          } else if (percent >= 80) {
            const badge = document.createElement('div');
            badge.className = 'badge likely';
            badge.textContent = '당선 유력';
            cardEl.appendChild(badge);
          }
        });
      }
    }

    renderAll();
    loadTurnout();
    setInterval(loadTurnout, 5000);

    const videoInput = document.getElementById('videoUpload');
    const video = document.getElementById('broadcastVideo');
    videoInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        video.src = URL.createObjectURL(file);
        video.play();
      }
    });

    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('ko-KR');
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>
