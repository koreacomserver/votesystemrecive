<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í•™êµ ì„ ê±° ê°œí‘œ ë°©ì†¡</title>
  <style>
    * { box-sizing: border-box; font-family: 'Pretendard', 'Segoe UI', sans-serif; }
    body { margin: 0; background: #0d1021; color: #fff; overflow: hidden; }

    header {
      background: linear-gradient(90deg, #2a2f66, #1c1f3a);
      padding: 10px 20px;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 1.2rem; font-weight: bold;
      border-bottom: 3px solid #3a52f8;
    }

    main {
      display: grid;
      grid-template-columns: 200px 1fr;
      height: calc(100vh - 60px);
    }

    .sidebar {
      background: #151832;
      padding: 1rem;
      display: flex; flex-direction: column; justify-content: space-around;
    }

    .sidebar div {
      background: #202456; padding: 1rem; border-radius: 10px;
      text-align: center; font-weight: bold; font-size: 1.1rem;
      border: 2px solid #4455cc; position: relative;
    }

    .sidebar .turnout {
      font-size: 0.9rem; color: #b0b8ff; margin-top: 8px;
    }

    .video-area {
      position: relative;
      background: black;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
    }

    canvas { 
        width: 100%; height: 100%; 
        object-fit: cover; 
        display: block; 
        background: #000; 
        position: absolute; /* ì˜¤ë²„ë ˆì´ ìš”ì†Œë“¤ì´ ìº”ë²„ìŠ¤ ìœ„ì— ì˜¬ ìˆ˜ ìˆë„ë¡ */
        top: 0; left: 0; 
    }

    /* ìƒˆë¡œìš´ ë¼ì´ë¸Œ ê·¸ë˜í”½ ìŠ¤íƒ€ì¼ */
    #liveTallyOverlay {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }

    .live-badge {
        background: #e74c3c; /* Red */
        padding: 5px 15px;
        border-radius: 5px;
        font-weight: 900;
        font-size: 1.5rem;
        animation: pulse 1.5s infinite;
        border: 2px solid white;
    }

    @keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
    }

    #tallyTicker {
        background: rgba(30, 40, 70, 0.8);
        padding: 8px 20px;
        border-radius: 5px;
        font-size: 1.1rem;
        font-weight: bold;
        border-left: 5px solid #3a6ff8;
        min-width: 300px;
    }
    /* ê¸°ì¡´ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
    .overlay {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: rgba(20, 24, 60, 0.9);
      display: grid; grid-template-columns: repeat(3, 1fr);
      padding: 15px 20px;
      gap: 10px;
    }

    .card {
      background: #161a3a;
      border-radius: 10px;
      padding: 10px 15px;
      display: flex; flex-direction: column;
      border: 2px solid #3a52f8;
      position: relative;
    }

    .card-header { font-size: 1.1rem; margin-bottom: 8px; font-weight: bold; color: #89a9ff; }

    .candidate { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
    .bar-bg { background: #202856; height: 10px; border-radius: 5px; overflow: hidden; width: 60%; }
    .bar-fill { background: #4a6eff; height: 10px; transition: width 0.5s; }
    .percent { font-weight: bold; width: 40px; text-align: right; }

    .badge {
      position: absolute;
      top: 8px;
      right: 10px;
      padding: 3px 8px;
      border-radius: 5px;
      font-size: 0.8rem;
      font-weight: bold;
      color: #000;
    }

    .likely {
      background: linear-gradient(90deg, #ffd84d, #ffed8a);
    }

    .confirmed {
      background: linear-gradient(90deg, #ffcc33, #fff2a8, #ffe680);
      color: #3b2f00;
    }
  </style>
</head>
<body>
  <header>
    <div>2026 ê²½ì‹ ì¤‘í•™êµ ì „êµ ì„ ê±°ë°©ì†¡</div>
    <div id="clock"></div>
  </header>

  <main>
    <div class="sidebar" id="sidebar">
      <div id="side-president">íšŒì¥<div class="turnout" id="turnout-president">íˆ¬í‘œìœ¨: 0%</div></div>
      <div id="side-vp_3rd">3í•™ë…„ ë¶€íšŒì¥<div class="turnout" id="turnout-vp_3rd">íˆ¬í‘œìœ¨: 0%</div></div>
      <div id="side-vp_2nd">2í•™ë…„ ë¶€íšŒì¥<div class="turnout" id="turnout-vp_2nd">íˆ¬í‘œìœ¨: 0%</div></div>
    </div>

    <div class="video-area">
      <!-- ğŸŒŸ ë¹„ë””ì˜¤ì™€ ì—…ë¡œë“œ ë²„íŠ¼ ëŒ€ì‹  ìº”ë²„ìŠ¤ ì‚½ì… --><canvas id="broadcastCanvas"></canvas>
      
      <!-- ìƒˆë¡œìš´ ë¼ì´ë¸Œ í‹°ì»¤ ìš”ì†Œ --><div id="liveTallyOverlay">
          <div class="live-badge">LIVE</div>
          <div id="tallyTicker">ê°œí‘œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      </div>
      
      <div class="overlay" id="results"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // ğŸŒŸ Canvas Animation Logic (Start) - ì‹¤ì œ ê°œí‘œ ë°©ì†¡ ê·¸ë˜í”½ìœ¼ë¡œ ë³€ê²½
    const canvas = document.getElementById('broadcastCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;

    function resizeCanvas() {
        width = canvas.clientWidth;
        height = canvas.clientHeight;
        canvas.width = width;
        canvas.height = height;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ì„ì‹œë¡œ ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•œ í›„ë³´ì ë°ì´í„° ì €ì¥
    const animatedCandidateData = {}; // { positionKey: [{ name, votes: currentVotes, targetVotes, currentPercent, targetPercent }, ...] }

    // ìˆ«ì ì¹´ìš´í„° ì• ë‹ˆë©”ì´ì…˜ í—¬í¼ í•¨ìˆ˜
    function animateValue(obj, start, end, duration, propertyName) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj[propertyName] = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }
    
    function animatePercent(obj, start, end, duration, propertyName) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj[propertyName] = (progress * (end - start) + start); // ì†Œìˆ˜ì  ìœ ì§€
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }


    function drawBackgroundGrid() {
        ctx.fillStyle = '#0d1021';
        ctx.fillRect(0, 0, width, height);

        ctx.strokeStyle = 'rgba(58, 111, 248, 0.1)';
        ctx.lineWidth = 1;

        const gridSize = 50;
        for (let x = 0; x < width; x += gridSize) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
        }
        for (let y = 0; y < height; y += gridSize) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
        }
    }

    // ë°ì´í„° íë¦„ íš¨ê³¼ (ì‘ì€ ì ë“¤)
    let flowParticles = [];
    const MAX_FLOW_PARTICLES = 30;

    class FlowParticle {
        constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.vx = (Math.random() - 0.5) * 1.5;
            this.vy = (Math.random() - 0.5) * 1.5;
            this.radius = Math.random() * 1.5 + 0.5;
            this.alpha = Math.random() * 0.8 + 0.2;
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.alpha -= 0.005;

            if (this.alpha <= 0 || this.x < 0 || this.x > width || this.y < 0 || this.y > height) {
                this.reset();
            }
        }

        reset() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.vx = (Math.random() - 0.5) * 1.5;
            this.vy = (Math.random() - 0.5) * 1.5;
            this.alpha = Math.random() * 0.8 + 0.2;
        }

        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(58, 111, 248, ${this.alpha})`;
            ctx.fill();
        }
    }

    function initFlowParticles() {
        for (let i = 0; i < MAX_FLOW_PARTICLES; i++) {
            flowParticles.push(new FlowParticle());
        }
    }
    initFlowParticles();


    function drawMainElectionGraphic() {
        const mainPositionKey = 'president'; // íšŒì¥ ì„ ê±°ë¥¼ ë©”ì¸ìœ¼ë¡œ í‘œì‹œ
        const mainData = animatedCandidateData[mainPositionKey];
        if (!mainData || mainData.length === 0) {
            ctx.fillStyle = 'white';
            ctx.font = '24px Pretendard';
            ctx.textAlign = 'center';
            ctx.fillText("íšŒì¥ ì„ ê±° ë°ì´í„°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...", width / 2, height / 2);
            return;
        }

        // ê·¸ë˜í”„ ì˜ì—­ ì„¤ì •
        const graphAreaX = width * 0.1;
        const graphAreaY = height * 0.2;
        const graphAreaWidth = width * 0.8;
        const graphAreaHeight = height * 0.6;
        const barHeight = 60;
        const barSpacing = 20;

        ctx.font = '36px Pretendard';
        ctx.fillStyle = '#89a9ff';
        ctx.textAlign = 'left';
        ctx.fillText(`${positions.find(p => p.key === mainPositionKey).label} ë“í‘œ í˜„í™©`, graphAreaX, graphAreaY - 40);

        mainData.forEach((c, index) => {
            const y = graphAreaY + index * (barHeight + barSpacing);
            
            // ë§‰ëŒ€ ë°°ê²½ (ê³ ì •)
            ctx.fillStyle = 'rgba(32, 40, 86, 0.6)';
            ctx.fillRect(graphAreaX, y, graphAreaWidth, barHeight);

            // ë§‰ëŒ€ ì±„ìš°ê¸° (ì• ë‹ˆë©”ì´ì…˜)
            const currentBarWidth = graphAreaWidth * (c.currentPercent / 100);
            ctx.fillStyle = '#4a6eff'; // ì§„í•œ íŒŒë€ìƒ‰
            ctx.fillRect(graphAreaX, y, currentBarWidth, barHeight);

            // í›„ë³´ì ì´ë¦„
            ctx.fillStyle = 'white';
            ctx.font = 'bold 28px Pretendard';
            ctx.fillText(c.name, graphAreaX + 20, y + barHeight / 2 + 10);

            // ë“í‘œìœ¨ (ì• ë‹ˆë©”ì´ì…˜)
            ctx.font = 'bold 32px Pretendard';
            ctx.textAlign = 'right';
            ctx.fillText(`${c.currentPercent.toFixed(1)}%`, graphAreaX + graphAreaWidth - 20, y + barHeight / 2 + 12);

            // ë“í‘œìˆ˜ (ì• ë‹ˆë©”ì´ì…˜)
            ctx.font = '22px Pretendard';
            ctx.fillStyle = '#ccc';
            ctx.fillText(`${c.currentVotes.toLocaleString()}í‘œ`, graphAreaX + graphAreaWidth - 20, y + barHeight / 2 + 40);

            ctx.textAlign = 'left'; // ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì •ë ¬ ì´ˆê¸°í™”
        });
    }


    function animateCanvas() {
        drawBackgroundGrid();
        flowParticles.forEach(p => { p.update(); p.draw(); }); // ë°ì´í„° íë¦„ íš¨ê³¼
        drawMainElectionGraphic(); // ë©”ì¸ ê°œí‘œ í˜„í™© ê·¸ë˜í”½

        requestAnimationFrame(animateCanvas);
    }
    animateCanvas();
    // ğŸŒŸ Canvas Animation Logic (End)

    const firebaseConfig = {
      apiKey: "AIzaSyCLge3LmR3bCTb7gKnVMVh2s_xt7zpdQYg",
      authDomain: "votesystemserver.firebaseapp.com",
      projectId: "votesystemserver",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const positions = [
      { key: 'president', label: 'íšŒì¥' },
      { key: 'vp_3rd', label: '3í•™ë…„ ë¶€íšŒì¥' },
      { key: 'vp_2nd', label: '2í•™ë…„ ë¶€íšŒì¥' }
    ];

    const voterCounts = {};
    const leadingCandidates = {}; 
    let currentTickerIndex = 0;

    async function renderAll() {
      const container = document.getElementById('results');
      container.innerHTML = '';

      for (const pos of positions) {
        // 1. ì¹´ë“œ êµ¬ì¡° ìƒì„±
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `card-${pos.key}`;
        container.appendChild(card);

        // 2. ìœ ê¶Œì ìˆ˜ (meta ë¬¸ì„œ) ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const metaDocRef = doc(db, `elections/2025/${pos.key}/meta`);
        onSnapshot(metaDocRef, (metaSnap) => {
            if (metaSnap.exists()) {
                voterCounts[pos.key] = Number(metaSnap.data().totalVoters) || 0;
            } else {
                voterCounts[pos.key] = 0;
            }
        });

        // 3. í›„ë³´ì ë“í‘œìˆ˜ (ì»¬ë ‰ì…˜) ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        const col = collection(db, `elections/2025/${pos.key}`);
        onSnapshot(col, snap => {
          const data = [];
          snap.forEach(doc => {
            // ë¬¸ì„œ IDê°€ 'meta'ì¸ ê²½ìš° í›„ë³´ì ëª©ë¡ì—ì„œ ì œì™¸
            if (doc.id === 'meta') { 
              return; 
            }
            data.push({ id: doc.id, ...doc.data() });
          });
          
          data.sort((a, b) => b.votes - a.votes);
          const top3 = data.slice(0, 3);
          const totalVotesCast = data.reduce((sum, c) => sum + Number(c.votes || 0), 0);
          
          const totalVoters = voterCounts[pos.key] || 0;

          // íˆ¬í‘œìœ¨ ê³„ì‚° (Total Votes Cast / Total Registered Voters)
          const turnoutPercent = totalVoters > 0 ? ((totalVotesCast / totalVoters) * 100).toFixed(1) : '0.0';

          // ì‚¬ì´ë“œë°” íˆ¬í‘œìœ¨ ì—…ë°ì´íŠ¸
          const turnoutEl = document.getElementById(`turnout-${pos.key}`);
          if (turnoutEl) turnoutEl.textContent = `íˆ¬í‘œìœ¨: ${turnoutPercent}%`;
          
          // ì„ ë‘ í›„ë³´ ì •ë³´ ì €ì¥ (í‹°ì»¤ ì—…ë°ì´íŠ¸ìš©)
          if (top3.length > 0) {
              const winner = top3[0];
              const percent = totalVotesCast ? ((winner.votes / totalVotesCast) * 100).toFixed(1) : '0.0';
              
              leadingCandidates[pos.key] = {
                  label: pos.label,
                  name: winner.name,
                  percent: percent,
                  votes: winner.votes
              };
          } else {
               leadingCandidates[pos.key] = null;
          }

          const cardEl = document.getElementById(`card-${pos.key}`);
          // ì¹´ë“œ ë‚´ìš© ì—…ë°ì´íŠ¸ (í›„ë³´ì ë“í‘œìœ¨)
          cardEl.innerHTML = `
            <div class='card-header'>${pos.label}</div>
            ${top3.map(c => {
              // í›„ë³´ì ë“í‘œìœ¨ ê³„ì‚°ì€ ì´ íˆ¬í‘œìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.
              const candidatePercent = totalVotesCast ? ((c.votes/totalVotesCast*100).toFixed(1)) : '0.0';
              return `
                <div class='candidate'>
                  <span>${c.name}</span>
                  <div class='bar-bg'><div class='bar-fill' style='width:${candidatePercent}%'></div></div>
                  <span class='percent'>${candidatePercent}%</span>
                </div>
              `;
            }).join('')}
          `;

          // ë°°ì§€ ì—…ë°ì´íŠ¸ (íˆ¬í‘œ ì™„ë£Œ ìƒíƒœ)
          const existingBadge = cardEl.querySelector('.badge');
          if (existingBadge) existingBadge.remove();

          const turnoutNum = parseFloat(turnoutPercent);

          if (turnoutNum >= 98) {
              const badge = document.createElement('div');
              badge.className = 'badge confirmed';
              badge.textContent = 'ë‹¹ì„  í™•ì •'; // íˆ¬í‘œ ì™„ë£Œê°€ 98% ì´ìƒì¼ ë•Œ ë‹¹ì„  í™•ì •ìœ¼ë¡œ ê°„ì£¼
              cardEl.appendChild(badge);
          } else if (turnoutNum >= 80) {
              const badge = document.createElement('div');
              badge.className = 'badge likely';
              badge.textContent = 'ê°œí‘œ ì™„ë£Œ ì„ë°•'; // íˆ¬í‘œ ì™„ë£Œê°€ 80% ì´ìƒì¼ ë•Œ
              cardEl.appendChild(badge);
          }

          // ğŸŒŸ ìº”ë²„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ìš© ë°ì´í„° ì—…ë°ì´íŠ¸
          if (pos.key === 'president') { // ë©”ì¸ í™”ë©´ì€ 'íšŒì¥' ì§ì±…ìœ¼ë¡œ ê³ ì •
              const currentAnimatedData = animatedCandidateData[pos.key] || [];
              const newAnimatedData = [];
              const animationDuration = 800; // 0.8ì´ˆ ì• ë‹ˆë©”ì´ì…˜

              data.forEach(c => {
                  const existing = currentAnimatedData.find(ac => ac.id === c.id);
                  const targetVotes = Number(c.votes || 0);
                  const targetPercent = totalVotesCast ? ((targetVotes / totalVotesCast) * 100) : 0;

                  if (existing) {
                      // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì• ë‹ˆë©”ì´ì…˜ ì—…ë°ì´íŠ¸
                      animateValue(existing, existing.currentVotes, targetVotes, animationDuration, 'currentVotes');
                      animatePercent(existing, existing.currentPercent, targetPercent, animationDuration, 'currentPercent');
                      newAnimatedData.push(existing);
                  } else {
                      // ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€ (ì´ˆê¸°ê°’ì€ 0ì—ì„œ ì‹œì‘)
                      const newCand = { 
                          id: c.id, 
                          name: c.name, 
                          currentVotes: 0, 
                          targetVotes: targetVotes,
                          currentPercent: 0,
                          targetPercent: targetPercent
                      };
                      animateValue(newCand, 0, targetVotes, animationDuration, 'currentVotes');
                      animatePercent(newCand, 0, targetPercent, animationDuration, 'currentPercent');
                      newAnimatedData.push(newCand);
                  }
              });
              animatedCandidateData[pos.key] = newAnimatedData;
          }
        }); // end onSnapshot(col, ...)
      } // end for loop
    } // end renderAll
    
    // ë¼ì´ë¸Œ í‹°ì»¤ë¥¼ ìˆœí™˜í•˜ë©° ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateLiveTallyTicker() {
        // ë°ì´í„°ê°€ ìˆëŠ” ì§ì±…ì˜ í‚¤ë§Œ í•„í„°ë§
        const keys = positions.map(p => p.key).filter(k => leadingCandidates[k]);
        
        const tickerEl = document.getElementById('tallyTicker');

        if (keys.length === 0) {
            tickerEl.textContent = "ğŸ“¢ ê°œí‘œ ì •ë³´ ì—…ë°ì´íŠ¸ ëŒ€ê¸° ì¤‘... (ê´€ë¦¬ì ì•±ì—ì„œ í›„ë³´ìë¥¼ ë“±ë¡í•´ ì£¼ì„¸ìš”.)";
            return;
        }

        // ë‹¤ìŒ ì§ì±…ìœ¼ë¡œ ì¸ë±ìŠ¤ ì´ë™
        currentTickerIndex = (currentTickerIndex + 1) % keys.length;
        const currentKey = keys[currentTickerIndex];
        const leader = leadingCandidates[currentKey];

        // í‹°ì»¤ ë‚´ìš© ì—…ë°ì´íŠ¸
        tickerEl.textContent = `âš¡ï¸ ${leader.label} (ì„ ë‘: ${leader.name}) - ë“í‘œìœ¨ ${leader.percent}% / ${leader.votes}í‘œ`;
    }

    renderAll(); 

    // 3ì´ˆë§ˆë‹¤ ë¼ì´ë¸Œ í‹°ì»¤ ì—…ë°ì´íŠ¸ ì‹œì‘
    setInterval(updateLiveTallyTicker, 3000); 

    function updateClock() {
      const now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('ko-KR');
    }
    setInterval(updateClock, 1000);
    updateClock();
  </script>
</body>
</html>
